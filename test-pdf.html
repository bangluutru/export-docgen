<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PDF Renderer Test v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="xlsx-reader.js"></script>
    <script src="template-engine.js"></script>
    <script src="svg-pdf-renderer.js"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 1100px;
            margin: 20px auto;
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .pass {
            color: #4caf50;
        }

        .fail {
            color: #f44336;
        }

        .info {
            color: #64b5f6;
        }

        pre {
            background: #16213e;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
        }

        h1 {
            color: #e94560;
        }

        #log {
            white-space: pre-wrap;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 8px;
            margin: 6px;
        }

        button:hover {
            background: #c42b4b;
        }
    </style>
</head>

<body>
    <h1>ðŸ§ª HTML-PDF Renderer Test v2</h1>
    <button onclick="runTest()">â–¶ Test PDF (template-based)</button>
    <button onclick="runTestNoTpl()">â–¶ Test PDF (no template)</button>
    <pre id="log"></pre>
    <script>
        const log = document.getElementById('log');
        function p(msg, cls = '') { log.innerHTML += `<span class="${cls}">${msg}</span>\n`; }

        async function runTest() {
            log.innerHTML = '';
            p('=== HTML-PDF Renderer Test (with template) ===', 'info');

            try {
                p('\n[1] Loading template...', 'info');
                const tplResp = await fetch('template_mau.xlsx');
                const tplBuffer = await tplResp.arrayBuffer();
                const templateData = await TemplateEngine.analyzeTemplate(tplBuffer);
                p(`   Sheets: ${templateData.sheetNames.join(', ')}`);
                p(`   sheetPaths: ${templateData.sheetPaths?.join(', ') || 'MISSING!'}`);
                p(`   zip: ${templateData.zip ? 'OK' : 'MISSING!'}`);
                p(`   âœ“ Template loaded`, 'pass');

                p('\n[2] Loading data...', 'info');
                const dataResp = await fetch('test_data.xlsx');
                const dataBuffer = await dataResp.arrayBuffer();
                const workbook = await XLSXReader.read(dataBuffer);
                const sheet = workbook.sheets[workbook.sheetNames[0]];
                p(`   Rows: ${sheet.rows.length}, Headers: ${sheet.headers.join(', ')}`);
                p(`   âœ“ Data loaded`, 'pass');

                p('\n[3] Generating PDF from template...', 'info');
                const t0 = performance.now();
                const blob = await SVGPDFRenderer.renderToPDF({
                    headers: sheet.headers,
                    rows: sheet.rows,
                    templateData: templateData,
                    title: '',
                    pageSize: 'a4',
                    landscape: true,
                });
                const t1 = performance.now();

                const sizeKB = (blob.size / 1024).toFixed(1);
                p(`   Output size: ${sizeKB} KB`, sizeKB < 500 ? 'pass' : 'fail');
                p(`   Time: ${(t1 - t0).toFixed(0)} ms`);

                saveAs(blob, 'test_html_pdf_v2.pdf');
                p('\nðŸ“¥ Downloaded test_html_pdf_v2.pdf', 'pass');
                p('=== COMPLETE ===', 'pass');
            } catch (err) {
                p(`\nâœ— ERROR: ${err.message}`, 'fail');
                p(err.stack, 'fail');
            }
        }

        async function runTestNoTpl() {
            log.innerHTML = '';
            p('=== HTML-PDF Test (no template) ===', 'info');

            try {
                const dataResp = await fetch('test_data.xlsx');
                const dataBuffer = await dataResp.arrayBuffer();
                const workbook = await XLSXReader.read(dataBuffer);
                const sheet = workbook.sheets[workbook.sheetNames[0]];

                const t0 = performance.now();
                const blob = await SVGPDFRenderer.renderToPDF({
                    headers: sheet.headers,
                    rows: sheet.rows,
                    title: 'BÃO CÃO Dá»® LIá»†U',
                    pageSize: 'a4',
                    landscape: false,
                });
                const t1 = performance.now();

                p(`   Size: ${(blob.size / 1024).toFixed(1)} KB, Time: ${(t1 - t0).toFixed(0)} ms`);
                saveAs(blob, 'test_html_pdf_notpl.pdf');
                p('ðŸ“¥ Downloaded', 'pass');
            } catch (err) {
                p(`âœ— ERROR: ${err.message}`, 'fail');
                p(err.stack, 'fail');
            }
        }
    </script>
</body>

</html>