<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Font Test â€” Noto Sans JP</title>
    <style>
        body {
            font-family: sans-serif;
            background: #111;
            color: #eee;
            padding: 30px;
        }

        .pass {
            color: #4caf50;
        }

        .fail {
            color: #f44336;
        }

        .info {
            color: #90caf9;
        }

        #log {
            white-space: pre-wrap;
            font-family: monospace;
            line-height: 1.8;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <h1>ğŸ”¤ Font Test â€” Noto Sans JP + jsPDF</h1>
    <div id="log">Running tests...\n</div>

    <!-- Load the same scripts as index.html -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="font-loader.js"></script>

    <script>
        (async function () {
            const log = document.getElementById('log');
            function print(msg, cls) {
                const span = document.createElement('span');
                span.className = cls || '';
                span.textContent = msg + '\n';
                log.appendChild(span);
            }

            let passed = 0, failed = 0;

            function assert(label, condition) {
                if (condition) {
                    print(`âœ… PASS: ${label}`, 'pass');
                    passed++;
                } else {
                    print(`âŒ FAIL: ${label}`, 'fail');
                    failed++;
                }
            }

            // Test 1: FontLoader exists
            assert('FontLoader is defined', typeof FontLoader !== 'undefined');

            // Test 2: Load and register font with jsPDF
            try {
                const jsPDFLib = window.jspdf || window.jsPDF;
                assert('jsPDF library loaded', !!jsPDFLib);

                const doc = new jsPDFLib.jsPDF();
                print('â³ Loading Noto Sans JP font...', 'info');

                const t0 = performance.now();
                await FontLoader.registerFont(doc);
                const loadTime = (performance.now() - t0).toFixed(0);
                print(`â±ï¸ Font loaded in ${loadTime}ms`, 'info');

                assert('Font registered successfully', true);
                assert('FontLoader.isLoaded() returns true', FontLoader.isLoaded());

                // Test 3: Write text in multiple languages
                doc.setFont('NotoSansJP', 'bold');
                doc.setFontSize(18);
                doc.text('Font Test â€” Unicode Support', 20, 20);

                doc.setFont('NotoSansJP', 'normal');
                doc.setFontSize(14);
                doc.text('æ—¥æœ¬èªãƒ†ã‚¹ãƒˆ: å“åã€å®¹é‡ã€é‡‘é¡', 20, 40);
                doc.text('ã‚«ã‚¿ã‚«ãƒŠ: ã‚¢ã‚¤ã‚¦ã‚¨ã‚ª', 20, 55);
                doc.text('æ¼¢å­—: æ±äº¬éƒ½åƒä»£ç”°åŒº', 20, 70);
                doc.text('Tiáº¿ng Viá»‡t: Äƒáº¯Ä‘Æ¡Æ°á»© á»…á»‡ á»•á»—', 20, 85);
                doc.text('English: Hello World 123', 20, 100);
                assert('Text rendering (no errors thrown)', true);

                // Test 4: autoTable with Unicode
                doc.autoTable({
                    head: [['STT', 'å“å / TÃªn SP', 'å®¹é‡ / Dung lÆ°á»£ng', 'é‡‘é¡ / GiÃ¡']],
                    body: [
                        ['1', 'ã‚³ãƒ¼ãƒ’ãƒ¼', '250ml', 'Â¥150'],
                        ['2', 'CÃ  phÃª sá»¯a Ä‘Ã¡', '330ml', 'â‚«35,000'],
                        ['3', 'ç·‘èŒ¶', '500ml', 'Â¥120'],
                    ],
                    startY: 115,
                    styles: { font: 'NotoSansJP', fontSize: 10 },
                    headStyles: { fillColor: [99, 102, 241], fontStyle: 'bold' },
                });
                assert('autoTable with Unicode data', true);

                // Test 5: Generate PDF blob
                const pdfBlob = doc.output('blob');
                assert('PDF blob generated', pdfBlob.size > 1000);
                print(`ğŸ“„ PDF size: ${(pdfBlob.size / 1024).toFixed(1)} KB`, 'info');

                // Save for manual verification
                doc.save('font-test-unicode.pdf');
                assert('PDF saved as font-test-unicode.pdf', true);

            } catch (err) {
                print(`âŒ ERROR: ${err.message}`, 'fail');
                print(`Stack: ${err.stack}`, 'fail');
                failed++;
            }

            // Summary
            print('');
            print(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`, '');
            const total = passed + failed;
            if (failed === 0) {
                print(`ğŸ‰ ALL ${total} TESTS PASSED!`, 'pass');
            } else {
                print(`âš ï¸ ${passed}/${total} passed, ${failed} failed`, 'fail');
            }
            document.title = failed === 0 ? `âœ… All ${total} tests passed` : `âŒ ${failed} failed`;
        })();
    </script>
</body>

</html>